var loginRefer = null;
var loginRequestCallback = null;
var loginRequestWorkCallback = null;
var loginCommandRequest = null;

var refreshLoginArea = function () {
    requestPage('?pagAjax=login&refer=' + loginRefer, 'loginResult', 'GET');

    if (loginRequestCallback !== null) {
        loginRequestCallback();
    }
};

var loginSexyAlert = {
    info: function (info, callback) {
        Sexy.info(info, {
            onComplete: function () {
                if (callback) {
                    callback();
                }
            }
        });
    },

    error: function (info, callback) {
        Sexy.error(info, {
            onComplete: function () {
                if (callback) {
                    callback();
                }
            }
        });
    },

    alert: function (info, callback) {
        Sexy.alert(info, {
            onComplete: function () {
                if (callback) {
                    callback();
                }
            }
        });
    }
};

/** Google Login **/
var googleAuth2 = null;

var googleSignIn = function () {
    setRequestPageLoader('loginResult');

    setTimeout(function () {
        googleAuth2.signIn().then(function (googleUser) {
            requestPage('?pagAjax=login&acao=google-login-request&refer=' + loginRefer + '&callback=' + loginRequestCallbackName + '&work-callback=' + loginRequestWorkCallbackName + '&cmd=' + loginCommandRequest, 'loginResult', 'POST', $.param({
                'idToken': googleUser.getAuthResponse().id_token
            }));
        }, function (error) {
            refreshLoginArea();

            if ((error.error || null) !== "popup_closed_by_user") {
                requestPage('?pagAjax=login&acao=google-login-cancel&refer=' + loginRefer,'loginResult', 'GET');
            } else {
                Sexy.error("Falha ao logar no Google.");
                console.error(error);
            }
        });
    });
};

function googleLoginSelectAccount(username) {
    if (loginRequestWorkCallback !== null) {
        loginRequestWorkCallback();
    }

    requestPage('?pagAjax=login&acao=google-login-connect&refer=' + loginRefer,'loginResult','POST', $.param({
        username: username
    }));
}

function googleLoginRegister() {
    var message = "Informe um <strong>login</strong> entre <em>4 e 10 dígitos</em> para que possamos prosseguir com seu cadastro.<br>É permitido o uso de letras, números e o seguintes símbolos: <em>.-_</em>";

    Sexy.prompt(message, '', {
        onComplete: function (username) {
            if (username === false) {
                loginSexyAlert.info("<strong>Obrigado pelo interesse no MuAwaY!</strong><br><br>Caso queira continuar com seu cadastro, clique no <strong>Login com o Google</strong novamente.<br><br>Estaremos sempre de portas abertas para você em nosso continente.");
                return;
            }

            if ((username || "").length < 4 || (username || "").length > 10) {
                loginSexyAlert.alert("O <strong>login</strong> precisa ser entre 4 e 10 digitos.", googleLoginRegister);
                return;
            }

            if (/[^a-zA-Z0-9\.-_]/g.test(username) === true) {
                loginSexyAlert.error("O campo <strong>login</strong> está incompatível com as regras.<br>Utilize somente números, letras minúsculas, e os seguintes símbolos: <em>._-</em>", googleLoginRegister);
                return;
            }

            if (/[A-Z]/g.test(username) === true) {
                loginSexyAlert.error("O campo <strong>login</strong> só pode conter letras minúsculas.", googleLoginRegister);
                return;
            }

            setRequestPageLoader('loginResult');

            if (loginRequestWorkCallback !== null) {
                loginRequestWorkCallback();
            }

            $.ajax({
                method: 'POST',
                url: '?pagAjax=cadastro&cadastrar=google',
                dataType: 'json',
                data: {
                    username: username
                }
            }).done(function (response) {
                switch (response.type) {
                    case "error":
                        loginSexyAlert.error(response.message, googleLoginRegister);
                        break;
                    case "warning":
                    case "alert":
                        loginSexyAlert.alert(response.message, googleLoginRegister);
                        break;
                    case "register-success":
                        loginSexyAlert.info(response.message);
                        requestPage("?pagAjax=painelUsuario&categoria=minhaConta&open=personalData","mainSite","GET");
                        loginRequestCallback = null;
                        break;
                    default:
                        loginSexyAlert.error("Houve um erro desconhecido.", googleLoginRegister);
                        break;
                }

                refreshLoginArea();
            }).fail(function (error) {
                loginSexyAlert.error("Houve um erro ao finalizar o cadastro.<br>Por favor, tente novamente mais tarde.", googleLoginRegister);
                refreshLoginArea();
            });
        }
    });
}

function googleLoginRequestResult(accounts) {
    if (accounts.length === 1) {
        googleLoginSelectAccount(accounts[0]);
        return;
    }

    var content = "<form method='post' id='gooleLoginMultiplesLogins'>\
            <strong>Atenção:</strong><br />Encontramos mais de um login vinculado com esta conta Google. Selecione a conta que gostaria de logar:\
            <br /><br />\
            <select id='google-login-select-account' onchange='Sexy.hide();googleLoginSelectAccount(this.value);' style='visibility: visible !important; width: 100px;'>\
            <option value='' disabled selected>Selecionar</option>\
            ";

    for (var i = 0; i < accounts.length; i++) {
        content += "<option value='" + accounts[i] + "'>" + accounts[i] + "</option>";
    }

    content += "</select>\
            </form>";

    Sexy.info(content, {
        textBoxBtnOk: "Cancelar",
        onComplete: function(okBtn) {
            requestPage('?pagAjax=login&acao=google-login-cancel&refer=' + loginRefer,'loginResult', 'GET');
        },
        onShowComplete: function () {
            $('#gooleLoginMultiplesLogins').find('select').css('visibility', 'visible');
        }
    });

    if (loginRequestCallback !== null) {
        loginRequestCallback();
    }
}

function googleLoginRequestNoResult() {
    if (loginRequestCallback !== null) {
        loginRequestCallback();
    }

    Sexy.confirm("<strong>Não encontramos nenhuma conta MuAwaY associado a esta conta Google.</strong><br>Gostaria de se cadastrar rapidamente e fazer parte do nosso continente?", {
        onComplete: function (result) {
            if (result === true) {
                googleLoginRegister();
            }
        }
    });
}

/** Apple ID Sign In **/
function appleIdLoginSelectAccount(username) {
    if (loginRequestWorkCallback !== null) {
        loginRequestWorkCallback();
    }

    requestPage('?pagAjax=login&acao=apple-id-login-connect&refer=' + loginRefer,'loginResult','POST', $.param({
        username: username
    }));
}

function appleIdLoginRegister() {
    var message = "Informe um <strong>login</strong> entre <em>4 e 10 dígitos</em> para que possamos prosseguir com seu cadastro.<br>É permitido o uso de letras, números e o seguintes símbolos: <em>.-_</em>";

    Sexy.prompt(message, '', {
        onComplete: function (username) {
            if (username === false) {
                loginSexyAlert.info("<strong>Obrigado pelo interesse no MuAwaY!</strong><br><br>Caso queira continuar com seu cadastro, clique no <strong>Login com o Apple</strong novamente.<br><br>Estaremos sempre de portas abertas para você em nosso continente.");

                if (loginRequestCallback !== null) {
                    loginRequestCallback();
                }
                return;
            }

            if ((username || "").length < 4 || (username || "").length > 10) {
                loginSexyAlert.alert("O <strong>login</strong> precisa ser entre 4 e 10 digitos.", appleIdLoginRegister);
                return;
            }

            if (/[^a-zA-Z0-9\.-_]/g.test(username) === true) {
                loginSexyAlert.error("O campo <strong>login</strong> está incompatível com as regras.<br>Utilize somente números, letras minúsculas, e os seguintes símbolos: <em>._-</em>", appleIdLoginRegister);
                return;
            }

            if (/[A-Z]/g.test(username) === true) {
                loginSexyAlert.error("O campo <strong>login</strong> só pode conter letras minúsculas.", appleIdLoginRegister);
                return;
            }

            setRequestPageLoader('loginResult');

            if (loginRequestWorkCallback !== null) {
                loginRequestWorkCallback();
            }

            $.ajax({
                method: 'POST',
                url: '?pagAjax=cadastro&cadastrar=appleId',
                dataType: 'json',
                data: {
                    username: username
                }
            }).done(function (response) {
                switch (response.type) {
                    case "error":
                        loginSexyAlert.error(response.message, appleIdLoginRegister);
                        break;
                    case "warning":
                    case "alert":
                        loginSexyAlert.alert(response.message, appleIdLoginRegister);
                        break;
                    case "register-success":
                        loginSexyAlert.info(response.message, function () {
                            if (response.extra.isPrivateEmail === true) {
                                loginSexyAlert.alert("Detectamos que você está utilizando um e-mail privado de sua conta Apple.<br>Recomendamos que altere para um e-mail particular para evitar problemas futuros com recuperação de conta.<br><br><strong style='color: red'>Você pode alterar seu e-mail através do painel do usuário, recomendamos utilizar um e-mail que você acessa com regularmente.</strong>");
                            }
                        });
                        requestPage("?pagAjax=painelUsuario&categoria=minhaConta&open=personalData","mainSite","GET");
                        loginRequestCallback = null;
                        break;
                    default:
                        loginSexyAlert.error("Houve um erro desconhecido.", appleIdLoginRegister);
                        break;
                }

                refreshLoginArea();
            }).fail(function (error) {
                loginSexyAlert.error("Houve um erro ao finalizar o cadastro.<br>Por favor, tente novamente mais tarde.", appleIdLoginRegister);
                refreshLoginArea();
            });
        }
    });
}

function appleIdLoginRequestResult(accounts) {
    if (accounts.length === 1) {
        appleIdLoginSelectAccount(accounts[0]);
        return;
    }

    var content = "<form method='post' id='appleIdLoginMultiplesLogins'>\
            <strong>Atenção:</strong><br />Encontramos mais de um login vinculado com esta conta Apple. Selecione a conta que gostaria de logar:\
            <br /><br />\
            <select id='apple-id-login-select-account' onchange='Sexy.hide();appleIdLoginSelectAccount(this.value);' style='visibility: visible !important; width: 100px;'>\
            <option value='' disabled selected>Selecionar</option>\
            ";

    for (var i = 0; i < accounts.length; i++) {
        content += "<option value='" + accounts[i] + "'>" + accounts[i] + "</option>";
    }

    content += "</select>\
            </form>";

    Sexy.info(content, {
        textBoxBtnOk: "Cancelar",
        onComplete: function(okBtn) {
            requestPage('?pagAjax=login&acao=apple-id-login-cancel&refer=' + loginRefer,'loginResult', 'GET');
        },
        onShowComplete: function () {
            $('#appleIdLoginMultiplesLogins').find('select').css('visibility', 'visible');
        }
    });

    if (loginRequestCallback !== null) {
        loginRequestCallback();
    }
}

function appleIdLoginRequestNoResult() {
    if (loginRequestCallback !== null) {
        loginRequestCallback();
    }

    Sexy.confirm("<strong>Não encontramos nenhuma conta MuAwaY associado a este Apple ID.</strong><br>Gostaria de se cadastrar rapidamente e fazer parte do nosso continente?", {
        onComplete: function (result) {
            if (result === true) {
                appleIdLoginRegister();
            }
        }
    });
}

var appleIdSignIn = function () {
    appleLoginResponse = function (data) {
        setRequestPageLoader('loginResult');

        setTimeout(function() {
            var param = {
                'idToken': data.authorization.id_token,
                'code': data.authorization.code,
                'state': data.authorization.state
            };

            if (data.user !== undefined) {
                param.user = {
                    firstName: data.user.name.firstName,
                    lastName: data.user.name.lastName
                };
            }

            requestPage('?pagAjax=login&acao=apple-id-login-request&refer=' + loginRefer + '&callback=' + loginRequestCallbackName + '&work-callback=' + loginRequestWorkCallbackName + '&cmd=' + loginCommandRequest, 'loginResult', 'POST', $.param(param));
        });
    };

    appleLoginCancel = function () {
        requestPage('?pagAjax=login&acao=apple-id-login-cancel&refer=' + loginRefer,'loginResult', 'GET');

        if (loginRequestCallback !== null) {
            loginRequestCallback();
        }
    };

    setTimeout(function () {
        AppleID.auth.signIn();
    });
};

var appleLoginResponse = null;
var appleLoginCancel = null;

document.addEventListener('AppleIDSignInOnSuccess', function (event) {
    appleLoginResponse(event.detail);
});

document.addEventListener('AppleIDSignInOnFailure', function (event) {
    if ((event.detail.error || null) === "popup_closed_by_user") {
        if (appleLoginCancel !== null) {
            appleLoginCancel();
        }
    } else {
        Sexy.error("Falha ao logar na Apple.");
        console.error(error);
    }
});